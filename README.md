# 深圳大学体育场馆自动抢票脚本 🎾

版本: 1.2.1  
作者: zskfree  
许可证: MIT

---

## 概述

这是一个 Tampermonkey / 用户脚本，用于自动化预约深圳大学（SZU）体育场馆。脚本兼容 iOS、Android、iPad、移动端与桌面端，提供智能抢票、定时预约、重试/限频策略与可选的企业微信通知。

脚本元信息（来自脚本头部）：
- 名称: 深圳大学体育场馆自动抢票
- 版本: 1.2.1
- 运行环境: document-end
- 匹配地址:
  - https://ehall.szu.edu.cn/qljfwapp/sys/lwSzuCgyy/*
  - https://ehall-443.webvpn.szu.edu.cn/qljfwapp/sys/lwSzuCgyy/*
- 授权跨域/权限:
  - GM_xmlhttpRequest（跨域请求，用于企业微信推送等）
  - GM_setValue / GM_getValue（用于持久化设置/定时任务）
  - @connect qyapi.weixin.qq.com（企业微信 API 域名）

---

## 功能亮点

- 多时段预约：最多同时预约 2 个时间段（优先与备选）
- 场馆优先级：支持丽湖羽毛球馆的场馆优先级策略
- 自动重试与频率控制：可配置查询间隔、最大重试次数、请求超时；内置指数退避与错误分类
- 定时抢票：支持设定未来时间自动触发抢票并在页面刷新后恢复
- 移动端优化：屏幕唤醒、页面可见性监控、触控优化与响应式 UI
- 企业微信通知（可选）：预约成功后通过企业微信推送通知（需要用户配置 webhook 或企业微信应用信息）

---

## 安装

1. 安装浏览器用户脚本管理器（推荐 Tampermonkey）：https://www.tampermonkey.net/  
2. 从 Greasy Fork 安装脚本（或点击脚本头部的 @downloadURL）：  
   Greasy Fork: https://greasyfork.org/scripts/537386  
3. 在 Tampermonkey 中启用并确保脚本已被允许在目标页面运行。

提示（Windows 桌面端）：若使用浏览器扩展，某些浏览器需要在扩展设置中开启“开发者模式”或允许跨域 GM_xmlhttpRequest 权限。

---

## 使用与配置

访问深大场馆预约页面（脚本会在这些页面自动注入 UI）：
- 校内: `https://ehall.szu.edu.cn/qljfwapp/sys/lwSzuCgyy/`
- VPN: `https://ehall-443.webvpn.szu.edu.cn/qljfwapp/sys/lwSzuCgyy/`

### 基础设置（必填）
- 学号/工号：例如 `2300123999`（8–12 位数字）
- 姓名：例如 `张三`（2–10 个汉字）
- 预约日期：默认自动选“明天”，可手动调整
- 运动项目：羽毛球/篮球/网球/乒乓球/排球/桌球
- 校区：粤海 / 丽湖

### 高级设置（可选）
参数 | 范围 | 默认值 | 说明
---|---:|---:|---
查询间隔 | 1–60 秒 | 1 秒 | 每次查询的时间间隔
最大重试 | 10–9999 次 | 20000 次（历史默认）| 最大查询/重试次数（谨慎设太大）
请求超时 | 5–60 秒 | 10 秒 | 单次网络请求超时

> 注意：过短的间隔或过高的并发可能触发服务端限流，请合理设置。

### 场馆优先级（示例：丽湖羽毛球）
- 至畅体育馆：优先级最高（例如 5 号、10 号场位最优）
- 至快体育馆：次优
- 全部场馆：不限制

---

## 操作流程

立即抢票：
1. 点击页面上的“配置设置”展开面板
2. 填写或确认个人信息与预约参数
3. 勾选最多两个优先时间段（主/备）
4. 保存配置并点击“开始抢票”

定时抢票：
1. 在“定时抢票”区域选择目标日期和触发时间
2. 设置定时并保存，脚本将在到点自动开始抢票
3. 页面刷新后定时任务会自动恢复（因为配置已持久化）

桌面快捷键（仅桌面端）：
- Ctrl + Shift + S：开始 / 停止抢票
- Ctrl + Shift + H：显示 / 隐藏面板

---

## 日志与状态图标

图标 | 含义
---|---
🚀 | 启动：脚本开始抢票
🔍 | 查询：正在查询场地
🎉 / ✅ | 预约成功
❌ | 错误或失败
⚠️ | 警告或需注意
⏰ | 定时任务相关

---

## 企业微信推送（可选）

脚本支持在预约成功后发送企业微信通知，但需要你自行配置推送信息或企业微信 webhook。主要注意点：
- 脚本在元信息中允许跨域请求：@connect qyapi.weixin.qq.com
- 你需要在脚本设置中填写企业微信 webhook URL 或在脚本中按注释提示填写企业微信应用的 agentid、secret 等信息
- 为避免泄露敏感信息，建议仅在本地环境中配置并且不要将含敏感信息的配置上传到公共仓库

若需要，我可以把 README 中的「企业微信配置示例」与代码片段补全成可粘贴的步骤（需你确认使用 webhook 还是应用凭证）。

---

## 隐私与安全

- 所有数据（账号、姓名、设置）默认保存在本地浏览器（GM_setValue/localStorage），脚本不主动上传个人数据到第三方服务器。
- 企业微信推送会向企业微信 API 发起请求，请勿将 webhook/secret 泄露给不可信方。
- 使用本脚本可能违反学校或第三方平台的使用条款，请自行判断风险并负责使用后果。

---

## 常见问题

Q: 为什么一直显示“暂无可预约场地”？  
A: 常见原因包括预约时间未开放（通常开放时间为前一天中午 12:30）、场地已被预约完、或所选时间段不在可预约范围内。

Q: 如何提高成功率？  
A: 建议设置定时任务在开放时间准点触发、同时选择主/备时间段、查询间隔设为 1 秒并保证稳定网络。

Q: 能同时预约多个校区吗？  
A: 不能，每次只能选择一个校区。若需预约不同校区，需分别运行或切换配置。

---

## 更新日志（简要）

- v1.2.1 (当前)
  - 修正/同步脚本头部元信息与 README 中的版本信息
  - 增强跨域推送说明与安全提示
  - 若干 UI 与移动端稳定性优化（参见脚本内注释）

- v1.1.7 (2025-10-30)
  - 新增定时抢票功能
  - 新增实时倒计时显示
  - 优化篮球团体预约模式识别
  - 改进错误处理与重试逻辑
  - 修复重复预约检测问题

---

## 贡献与反馈

- 问题反馈：https://github.com/zskfree/SZU_Sports/issues  
- 功能建议 / 提交 PR：欢迎 Fork 并提交 Pull Request  
- Greasy Fork（脚本主页）：https://greasyfork.org/scripts/537386

---

## 免责声明

本脚本仅供学习交流使用，请遵守学校与平台的相关规定。因使用本脚本产生的任何后果由使用者自行承担。

---

MIT License © 2025 zskfree
