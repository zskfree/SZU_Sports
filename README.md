# 深圳大学体育场馆自动抢票脚本 🎾

## 📋 概述

这是一个功能强大的 Tampermonkey 用户脚本,用于自动化预约深圳大学体育场馆。支持 iOS、Android、移动端和桌面端全平台,提供智能抢票、定时预约、企业微信通知等功能。

**版本**: 1.1.8  
**作者**: zskfree  
**许可证**: MIT

---

## ✨ 核心特性

### 🎯 智能预约系统

- **多时段预约**: 最多同时预约 2 个时间段
- **场馆优先级**: 智能选择最优场地(丽湖羽毛球馆支持至畅/至快优先)
- **自动重试**: 可配置重试次数和间隔,智能避让网络拥堵
- **动态模式切换**: 自动识别篮球团体预约模式和单人散场模式

### ⏰ 定时任务

- **精准定时**: 支持设置未来任意时间自动开始抢票
- **实时倒计时**: 显示距离定时任务触发的剩余时间
- **任务持久化**: 页面刷新后自动恢复定时任务

### 📱 全平台适配（Windows端使用时，需要打开浏览器扩展的开发者模式）

- **响应式 UI**: 自动适配手机、平板、电脑屏幕
- **触控优化**: 完美支持触摸操作,防止误触
- **移动端增强**:
  - 屏幕保持唤醒
  - 页面可见性监控
  - 滚动性能优化

### 🔔 企业微信通知（使用这个功能的话需要自己修改部分代码）

- **即时推送**: 预约成功后自动发送企业微信消息
- **详细信息**: 包含场地、时间、单号等完整信息

### 🛡️ 网络优化

- **智能重试**: 根据错误类型自动调整重试策略
- **频率控制**: 限制请求频率,避免触发限流
- **超时处理**: 可配置请求超时时间
- **错误分类**: 区分网络错误、服务器错误、认证错误等

---

## 🚀 使用方法

### 1️⃣ 安装

1. 安装浏览器插件 [Tampermonkey](https://www.tampermonkey.net/)
2. 访问 [Greasy Fork](https://greasyfork.org/scripts/537386) 或点击脚本头部的 `@downloadURL`
3. 点击「安装此脚本」

### 2️⃣ 配置

访问深大场馆预约页面:

- 校内: `https://ehall.szu.edu.cn/qljfwapp/sys/lwSzuCgyy/`
- VPN: `https://ehall-443.webvpn.szu.edu.cn/qljfwapp/sys/lwSzuCgyy/`

#### 基础设置

| 参数 | 说明 | 示例 |
|------|------|------|
| 学号/工号 | 8-12位数字 | `2300123999` |
| 姓名 | 2-10个汉字 | `张三` |
| 预约日期 | 自动默认明天 | `2025-10-31` |
| 运动项目 | 羽毛球/篮球/网球/乒乓球/排球/桌球 | `羽毛球` |
| 校区 | 粤海/丽湖 | `丽湖` |

#### 高级设置

| 参数 | 范围 | 默认值 | 说明 |
|------|------|--------|------|
| 查询间隔 | 1-60秒 | 1秒 | 每次查询的时间间隔 |
| 最大重试 | 10-9999次 | 20000次 | 最大查询次数 |
| 请求超时 | 5-60秒 | 10秒 | 单次请求超时时间 |

#### 场馆优先级(丽湖羽毛球)

- **至畅体育馆**: 优先级最高
  - 5号场、10号场(最优)
  - 其他场地次之
  - 1号场、6号场相对较差
- **至快体育馆**: 次选
- **全部场馆**: 不限制

### 3️⃣ 操作

#### 立即抢票

1. 点击「⚙️ 配置设置」展开配置面板
2. 填写个人信息和预约参数
3. 勾选优先时间段(最多2个)
4. 点击「💾 保存配置」
5. 点击「🚀 开始抢票」

#### 定时抢票

1. 完成基础配置
2. 在「⏰ 定时抢票」区域选择日期和时间
3. 点击「⏰ 设置定时」
4. 系统将在指定时间自动开始抢票

---

## 🎮 快捷键(仅桌面端)

| 快捷键 | 功能 |
|--------|------|
| `Ctrl + Shift + S` | 开始/停止抢票 |
| `Ctrl + Shift + H` | 显示/隐藏面板 |

---

## 🏆 支持的运动项目

| 项目 | 代码 | 支持校区 | 特殊说明 |
|------|------|----------|----------|
| 🏸 羽毛球 | 001 | 粤海、丽湖 | 丽湖支持场馆优先级 |
| 🏀 篮球 | 005 | 粤海、丽湖 | 粤海校区使用团体预约模式 |
| 🎾 网球 | 004 | 粤海、丽湖 | - |
| 🏐 排球 | 003 | 粤海、丽湖 | - |
| 🏓 乒乓球 | 013 | 粤海、丽湖 | - |
| 🎱 桌球 | 016 | 粤海、丽湖 | - |

---

## 📊 日志说明

| 图标 | 类型 | 含义 |
|------|------|------|
| 🚀 | 启动 | 开始抢票 |
| 🔍 | 查询 | 正在查询场地 |
| 🎉 | 成功 | 找到可预约场地 |
| ✅ | 成功 | 预约成功 |
| ❌ | 错误 | 操作失败 |
| ⚠️ | 警告 | 需要注意 |
| 📊 | 统计 | 运行统计信息 |
| ⏰ | 定时 | 定时任务相关 |

---

## 🔧 技术特性

### 架构模块

#### 1. 设备检测模块(`Device`)

- 自动识别 iOS、Android、iPad、桌面设备
- 支持触控和指针事件检测

#### 2. 样式管理器(`Styles`)

- 响应式尺寸适配
- 动态计算 UI 元素大小

#### 3. 存储管理器(`Storage`)

- 多级存储策略: localStorage → sessionStorage → 内存存储
- 自动清理过期数据(7天)
- 版本兼容性检查

#### 4. 网络错误处理器(`NetworkErrorHandler`)

- 错误分类: 限流、服务器错误、认证错误、网络错误等
- 智能重试策略
- 指数退避算法

#### 5. 请求频率控制器(`RequestThrottler`)

- 限制每秒最大请求数(2次)
- 限制并发请求数(3个)
- 自动队列管理

#### 6. 智能重试机制(`SmartRetry`)

- 追踪连续失败次数
- 自动调整重试策略

#### 7. 移动端优化(`MobileOptimization`)

- 屏幕唤醒锁定
- 页面可见性监控
- 滚动性能优化

#### 8. 企业微信推送(`WeChatNotifier`)

- 跨域请求支持
- 消息模板化

---

## 🔒 隐私与安全

- ✅ 所有数据仅保存在本地浏览器
- ✅ 不上传任何个人信息到第三方服务器
- ✅ 企业微信推送使用官方 API,可选启用
- ✅ 开源代码,可自行审计

---

## ❓ 常见问题

### Q: 为什么一直显示"暂无可预约场地"?

**A**: 可能原因:

1. 预约时间未开放(通常在前一天中午12:30开放)
2. 场地已被预约完
3. 选择的时间段不在可预约范围内

### Q: 如何提高抢票成功率?

**A**: 建议:

1. 设置定时任务在开放时间准点触发
2. 选择多个备选时间段
3. 将查询间隔设为最小(1秒)
4. 保持网络稳定

### Q: 移动端如何保持页面不息屏?

**A**: 脚本自动申请屏幕唤醒锁定,无需手动操作。如失效,请检查浏览器权限设置。

### Q: 可以同时预约多个校区吗?

**A**: 不可以,每次只能选择一个校区。如需预约多个校区,需要分别运行。

### Q: 定时任务刷新页面后会丢失吗?

**A**: 不会,定时任务会自动保存并在页面刷新后恢复。

---

## 📝 更新日志

### v1.1.7 (2025-10-30)

- ✨ 新增定时抢票功能
- ✨ 新增实时倒计时显示
- 🔧 优化篮球团体预约模式识别
- 🔧 改进错误处理和重试逻辑
- 🐛 修复重复预约检测问题

---

## 🤝 贡献与反馈

- **问题反馈**: [GitHub Issues](https://github.com/zskfree/SZU_Sports)
- **功能建议**: 欢迎提交 Pull Request
- **Greasy Fork**: [脚本主页](https://greasyfork.org/scripts/537386)

---

## ⚠️ 免责声明

本脚本仅供学习交流使用,请遵守学校相关规定。使用本脚本产生的任何后果由使用者自行承担。

---

## 📄 许可证

MIT License © 2025 zskfree

---

**⭐ 如果觉得有用,请给个 Star!**
